import React, { useState, useEffect } from 'react';
import { Search, Plus, Edit2, Trash2, FileText, Download, Car, Wrench } from 'lucide-react';

const GarageManagement = () => {
  const [cars, setCars] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [showAddForm, setShowAddForm] = useState(false);
  const [showMaintenanceForm, setShowMaintenanceForm] = useState(false);
  const [selectedCar, setSelectedCar] = useState(null);
  const [editingCar, setEditingCar] = useState(null);
  
  const [carForm, setCarForm] = useState({
    plateNumber: '',
    ownerName: '',
    phone: '',
    carType: '',
    model: '',
    year: ''
  });

  const [maintenanceForm, setMaintenanceForm] = useState({
    date: new Date().toISOString().split('T')[0],
    partName: '',
    description: '',
    cost: ''
  });

  useEffect(() => {
    const savedCars = localStorage.getItem('garageCars');
    if (savedCars) {
      setCars(JSON.parse(savedCars));
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('garageCars', JSON.stringify(cars));
  }, [cars]);

  const handleAddCar = () => {
    if (!carForm.plateNumber || !carForm.ownerName) {
      alert('נא להזין מספר רישוי ושם הבעלים');
      return;
    }

    if (editingCar) {
      setCars(cars.map(car => 
        car.id === editingCar.id ? { ...car, ...carForm } : car
      ));
      setEditingCar(null);
    } else {
      const newCar = {
        id: Date.now(),
        ...carForm,
        maintenanceHistory: []
      };
      setCars([...cars, newCar]);
    }

    setCarForm({
      plateNumber: '',
      ownerName: '',
      phone: '',
      carType: '',
      model: '',
      year: ''
    });
    setShowAddForm(false);
  };

  const handleEditCar = (car) => {
    setCarForm({
      plateNumber: car.plateNumber,
      ownerName: car.ownerName,
      phone: car.phone,
      carType: car.carType,
      model: car.model,
      year: car.year
    });
    setEditingCar(car);
    setShowAddForm(true);
  };

  const handleDeleteCar = (carId) => {
    if (window.confirm('האם אתה בטוח שברצונך למחוק רכב זה?')) {
      setCars(cars.filter(car => car.id !== carId));
    }
  };

  const handleAddMaintenance = () => {
    if (!maintenanceForm.partName || !maintenanceForm.cost) {
      alert('נא להזין שם החלק והעלות');
      return;
    }

    const newMaintenance = {
      id: Date.now(),
      ...maintenanceForm
    };

    setCars(cars.map(car => 
      car.id === selectedCar.id 
        ? { ...car, maintenanceHistory: [...car.maintenanceHistory, newMaintenance] }
        : car
    ));

    setMaintenanceForm({
      date: new Date().toISOString().split('T')[0],
      partName: '',
      description: '',
      cost: ''
    });
    setShowMaintenanceForm(false);
    setSelectedCar(cars.find(car => car.id === selectedCar.id));
  };

  const exportToExcel = () => {
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
    csvContent += "מספר רישוי,שם הבעלים,מספר טלפון,סוג רכב,דגם,שנת ייצור\n";
    
    cars.forEach(car => {
      csvContent += `${car.plateNumber},${car.ownerName},${car.phone},${car.carType},${car.model},${car.year}\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "garage_data.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const filteredCars = cars.filter(car => 
    car.plateNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
    car.ownerName.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100" dir="rtl">
      <div className="container mx-auto px-4 py-8">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-8">
          <div className="flex items-center justify-between mb-8">
            <div className="flex items-center gap-3">
              <div className="bg-blue-600 p-3 rounded-xl">
                <Car className="text-white" size={32} />
              </div>
              <h1 className="text-4xl font-bold text-gray-800">מערכת ניהול מוסך</h1>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setShowAddForm(true)}
                className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition"
              >
                <Plus size={20} />
                הוסף רכב
              </button>
              <button
                onClick={exportToExcel}
                className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition"
              >
                <Download size={20} />
                ייצא לאקסל
              </button>
            </div>
          </div>

          <div className="relative mb-6">
            <Search className="absolute right-4 top-3.5 text-gray-400" size={20} />
            <input
              type="text"
              placeholder="חיפוש לפי מספר רישוי או שם בעלים..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pr-12 pl-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
            />
          </div>

          <div className="text-gray-600 mb-4">
            סך הכל רכבים: <span className="font-bold text-blue-600">{cars.length}</span>
          </div>
        </div>

        {showAddForm && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <h2 className="text-2xl font-bold mb-6 text-gray-800">
                {editingCar ? 'עריכת רכב' : 'הוספת רכב חדש'}
              </h2>
              
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">מספר רישוי *</label>
                  <input
                    type="text"
                    value={carForm.plateNumber}
                    onChange={(e) => setCarForm({...carForm, plateNumber: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">שם הבעלים *</label>
                  <input
                    type="text"
                    value={carForm.ownerName}
                    onChange={(e) => setCarForm({...carForm, ownerName: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">מספר טלפון</label>
                  <input
                    type="text"
                    value={carForm.phone}
                    onChange={(e) => setCarForm({...carForm, phone: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">סוג רכב</label>
                  <input
                    type="text"
                    value={carForm.carType}
                    onChange={(e) => setCarForm({...carForm, carType: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">דגם</label>
                  <input
                    type="text"
                    value={carForm.model}
                    onChange={(e) => setCarForm({...carForm, model: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">שנת ייצור</label>
                  <input
                    type="text"
                    value={carForm.year}
                    onChange={(e) => setCarForm({...carForm, year: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
              </div>

              <div className="flex gap-3 justify-end">
                <button
                  onClick={() => {
                    setShowAddForm(false);
                    setEditingCar(null);
                    setCarForm({
                      plateNumber: '',
                      ownerName: '',
                      phone: '',
                      carType: '',
                      model: '',
                      year: ''
                    });
                  }}
                  className="px-6 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition"
                >
                  ביטול
                </button>
                <button
                  onClick={handleAddCar}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                >
                  {editingCar ? 'עדכן' : 'הוסף'}
                </button>
              </div>
            </div>
          </div>
        )}

        {showMaintenanceForm && selectedCar && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl p-8 max-w-2xl w-full">
              <h2 className="text-2xl font-bold mb-6 text-gray-800">הוספת טיפול</h2>
              <p className="text-gray-600 mb-6">רכב: {selectedCar.plateNumber} - {selectedCar.ownerName}</p>
              
              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">תאריך *</label>
                  <input
                    type="date"
                    value={maintenanceForm.date}
                    onChange={(e) => setMaintenanceForm({...maintenanceForm, date: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">שם החלק *</label>
                  <input
                    type="text"
                    value={maintenanceForm.partName}
                    onChange={(e) => setMaintenanceForm({...maintenanceForm, partName: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">תיאור העבודה</label>
                  <textarea
                    value={maintenanceForm.description}
                    onChange={(e) => setMaintenanceForm({...maintenanceForm, description: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                    rows="3"
                  />
                </div>
                
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">עלות (₪) *</label>
                  <input
                    type="number"
                    value={maintenanceForm.cost}
                    onChange={(e) => setMaintenanceForm({...maintenanceForm, cost: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
              </div>

              <div className="flex gap-3 justify-end">
                <button
                  onClick={() => {
                    setShowMaintenanceForm(false);
                    setMaintenanceForm({
                      date: new Date().toISOString().split('T')[0],
                      partName: '',
                      description: '',
                      cost: ''
                    });
                  }}
                  className="px-6 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition"
                >
                  ביטול
                </button>
                <button
                  onClick={handleAddMaintenance}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                >
                  הוסף טיפול
                </button>
              </div>
            </div>
          </div>
        )}

        {selectedCar && !showMaintenanceForm && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-start mb-6">
                <div>
                  <h2 className="text-3xl font-bold text-gray-800 mb-2">{selectedCar.plateNumber}</h2>
                  <p className="text-xl text-gray-600">{selectedCar.ownerName}</p>
                </div>
                <button
                  onClick={() => setSelectedCar(null)}
                  className="text-gray-500 hover:text-gray-700 text-2xl"
                >
                  ×
                </button>
              </div>

              <div className="grid grid-cols-3 gap-4 mb-8 bg-gray-50 p-6 rounded-xl">
                <div>
                  <p className="text-gray-600 text-sm">טלפון</p>
                  <p className="font-semibold">{selectedCar.phone || '-'}</p>
                </div>
                <div>
                  <p className="text-gray-600 text-sm">סוג רכב</p>
                  <p className="font-semibold">{selectedCar.carType || '-'}</p>
                </div>
                <div>
                  <p className="text-gray-600 text-sm">דגם</p>
                  <p className="font-semibold">{selectedCar.model || '-'}</p>
                </div>
                <div>
                  <p className="text-gray-600 text-sm">שנה</p>
                  <p className="font-semibold">{selectedCar.year || '-'}</p>
                </div>
              </div>

              <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold text-gray-800">היסטוריית טיפולים</h3>
                <button
                  onClick={() => setShowMaintenanceForm(true)}
                  className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  <Plus size={18} />
                  הוסף טיפול
                </button>
              </div>

              {selectedCar.maintenanceHistory && selectedCar.maintenanceHistory.length > 0 ? (
                <div className="space-y-4">
                  {selectedCar.maintenanceHistory.sort((a, b) => new Date(b.date) - new Date(a.date)).map((maintenance) => (
                    <div key={maintenance.id} className="border-2 border-gray-200 rounded-xl p-6 hover:border-blue-300 transition">
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-3">
                          <Wrench className="text-blue-600" size={24} />
                          <div>
                            <h4 className="text-xl font-bold text-gray-800">{maintenance.partName}</h4>
                            <p className="text-gray-600 text-sm">{new Date(maintenance.date).toLocaleDateString('he-IL')}</p>
                          </div>
                        </div>
                        <div className="text-left">
                          <p className="text-2xl font-bold text-green-600">{maintenance.cost} ₪</p>
                        </div>
                      </div>
                      {maintenance.description && (
                        <p className="text-gray-700 bg-gray-50 p-3 rounded-lg">{maintenance.description}</p>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-12 bg-gray-50 rounded-xl">
                  <Wrench className="mx-auto text-gray-400 mb-4" size={48} />
                  <p className="text-gray-600">אין טיפולים רשומים עדיין</p>
                </div>
              )}
            </div>
          </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredCars.map((car) => (
            <div key={car.id} className="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <div className="bg-blue-100 p-2 rounded-lg">
                    <Car className="text-blue-600" size={24} />
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-800">{car.plateNumber}</h3>
                    <p className="text-gray-600">{car.ownerName}</p>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => handleEditCar(car)}
                    className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"
                  >
                    <Edit2 size={18} />
                  </button>
                  <button
                    onClick={() => handleDeleteCar(car.id)}
                    className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition"
                  >
                    <Trash2 size={18} />
                  </button>
                </div>
              </div>

              <div className="space-y-2 mb-4">
                <div className="flex justify-between text-sm">
                  <span className="text-gray-600">טלפון:</span>
                  <span className="font-semibold">{car.phone || '-'}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-gray-600">סוג:</span>
                  <span className="font-semibold">{car.carType || '-'}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-gray-600">דגם:</span>
                  <span className="font-semibold">{car.model || '-'}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-gray-600">שנה:</span>
                  <span className="font-semibold">{car.year || '-'}</span>
                </div>
              </div>

              <div className="border-t pt-4">
                <div className="flex justify-between items-center mb-3">
                  <span className="text-sm text-gray-600">טיפולים:</span>
                  <span className="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-bold">
                    {car.maintenanceHistory?.length || 0}
                  </span>
                </div>
                <button
                  onClick={() => setSelectedCar(car)}
                  className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-2 rounded-lg hover:from-blue-700 hover:to-blue-800 transition"
                >
                  <FileText size={18} />
                  הצג פרטים
                </button>
              </div>
            </div>
          ))}
        </div>

        {filteredCars.length === 0 && (
          <div className="bg-white rounded-2xl shadow-xl p-12 text-center">
            <Car className="mx-auto text-gray-400 mb-4" size={64} />
            <h3 className="text-2xl font-bold text-gray-600 mb-2">
              {searchTerm ? 'לא נמצאו רכבים' : 'אין רכבים במערכת'}
            </h3>
            <p className="text-gray-500">
              {searchTerm ? 'נסה לחפש במילות חיפוש אחרות' : 'התחל על ידי הוספת רכב חדש'}
            </p>
          </div>
        )}
      </div>
    </div>
  );
};

export default GarageManagement;
