<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מוסך</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase v9 Compatible Mode -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">טוען מערכת...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 bg-blue-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <h1 class="text-2xl font-bold text-center mb-6">מערכת ניהול מוסך</h1>
            
            <div id="errorMsg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="successMsg" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">אימייל</label>
                    <input type="email" id="email" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">סיסמה</label>
                    <input type="password" id="password" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <button type="submit" id="authBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                    התחבר
                </button>
            </form>
            
            <p class="text-center mt-4">
                <a href="#" id="toggleAuth" class="text-blue-600 hover:underline">אין לך חשבון? הירשם</a>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-bold">מערכת ניהול מוסך</h1>
                    <div class="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg">
                        <span class="text-gray-600">👤</span>
                        <span id="userName" class="font-bold text-blue-700">משתמש</span>
                        <button onclick="editUserName()" class="text-blue-600 hover:text-blue-800" title="ערוך שם">
                            ✏️
                        </button>
                    </div>
                </div>
                <button onclick="signOut()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    יציאה
                </button>
            </div>
            
            <div class="flex gap-4 mb-4 flex-wrap">
                <button onclick="openCarModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    + הוסף רכב
                </button>
                <button onclick="openDashboard()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2">
                    📊 לוח בקרה
                </button>
                <button onclick="openCalendarModal()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 flex items-center gap-2">
                    📅 יומן פגישות
                </button>
                <button onclick="openSettings()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 flex items-center gap-2">
                    ⚙️ הגדרות
                </button>
                <button onclick="openBackupModal()" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 flex items-center gap-2">
                    💾 גיבוי
                </button>
                <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    ייצא נתונים
                </button>
            </div>
            
            <input type="text" id="searchBox" placeholder="חיפוש..." onkeyup="searchCars()" 
                   class="w-full px-3 py-2 border rounded-lg">
        </div>

        <!-- Cars Grid -->
        <div id="carsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <p class="text-gray-500 text-xl">אין רכבים במערכת</p>
            <button onclick="openCarModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                הוסף רכב ראשון
            </button>
        </div>
    </div>

    <!-- Car Modal -->
    <div id="carModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full my-8">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-center">הוספת רכב חדש</h2>
            
            <form id="carForm">
                <!-- תמונת הרכב -->
                <div class="mb-4 text-center">
                    <label class="block text-gray-700 font-bold mb-2">תמונת הרכב</label>
                    <div class="flex justify-center">
                        <label class="cursor-pointer bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 hover:bg-gray-50 flex items-center gap-2">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span class="text-gray-600">העלה תמונה</span>
                            <input type="file" id="carImage" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <div id="imagePreview" class="mt-3"></div>
                    <p class="text-xs text-green-600 mt-1">✓ דחיסה אוטומטית</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- מספר רישוי -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">מספר רישוי *</label>
                        <input type="text" id="plateNumber" required 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="12-345-67">
                    </div>
                    
                    <!-- שם הבעלים -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">שם הבעלים *</label>
                        <input type="text" id="ownerName" required
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="שם מלא">
                    </div>
                    
                    <!-- סוג רכב -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">סוג רכב</label>
                        <input type="text" id="carType" list="carTypes"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="טויוטה, מרצדס, מזדה">
                        <datalist id="carTypes">
                            <option value="טויוטה">
                            <option value="הונדה">
                            <option value="יונדאי">
                            <option value="קיה">
                            <option value="מזדה">
                            <option value="מרצדס">
                            <option value="BMW">
                        </datalist>
                    </div>
                    
                    <!-- מספר טלפון -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">מספר טלפון</label>
                        <input type="text" id="phone" 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="050-1234567">
                    </div>
                    
                    <!-- דגם -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">דגם</label>
                        <input type="text" id="model"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="קורולה, אלנטרה, וכו'">
                    </div>
                    
                    <!-- שנת ייצור -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">שנת ייצור</label>
                        <input type="number" id="year" min="1900" max="2030"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="2020">
                    </div>
                    
                    <!-- קוד רכב (VIN) -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">קוד רכב (VIN)</label>
                        <input type="text" id="vinCode" maxlength="17"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="17 תווים">
                    </div>
                    
                    <!-- קוד התנעה -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">קוד התנעה (אימוביליזר)</label>
                        <input type="text" id="immobilizerCode"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="קוד סודי להתנעת הרכב">
                    </div>
                    
                    <!-- סוג מנוע -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">סוג מנוע</label>
                        <select id="engineType" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">בחר...</option>
                            <option value="בנזין">בנזין</option>
                            <option value="דיזל">דיזל</option>
                            <option value="היברידי">היברידי</option>
                            <option value="חשמלי">חשמלי</option>
                        </select>
                    </div>
                    
                    <!-- הספק מנוע -->
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-bold mb-2">הספק מנוע</label>
                        <input type="text" id="enginePower"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder='150 כ"ס / 2000 סמ"ק'>
                    </div>
                    
                    <!-- סטטוס רכב -->
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-bold mb-2">סטטוס רכב</label>
                        <select id="carStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="waiting">ממתין לטיפול</option>
                            <option value="in_progress">בטיפול</option>
                            <option value="ready">מוכן לאיסוף</option>
                            <option value="completed">הושלם</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold">
                        שמור
                    </button>
                    <button type="button" onclick="closeCarModal()" class="flex-1 bg-gray-400 text-white px-6 py-3 rounded-lg hover:bg-gray-500 font-bold">
                        ביטול
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg p-8 max-w-xl w-full my-8">
            <h2 class="text-2xl font-bold mb-6 text-center">הוספת טיפול</h2>
            
            <form id="maintenanceForm" class="space-y-4">
                <!-- תאריך -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">תאריך *</label>
                    <input type="date" id="maintenanceDate" 
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           value="">
                </div>
                
                <!-- קילומטראז' -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">קילומטראז' *</label>
                    <input type="number" id="kilometers" 
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           placeholder="מספר הקילומטרים">
                </div>
                
                <!-- שם החלק -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">שם החלק *</label>
                    <input type="text" id="partName" 
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           placeholder="">
                </div>
                
                <!-- תיאור העבודה -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">תיאור העבודה</label>
                    <textarea id="workDescription" rows="4" 
                              class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right resize-none"
                              placeholder=""></textarea>
                </div>
                
                <!-- עלות (₪) -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">עלות (₪) *</label>
                    <input type="number" id="totalCost" step="0.01"
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           placeholder="">
                </div>
                
                <!-- תמונות התקלה -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">תמונות התקלה</label>
                    <div class="flex items-center justify-end">
                        <label class="cursor-pointer bg-white border border-gray-300 rounded-lg px-4 py-2 hover:bg-gray-50 flex items-center gap-2">
                            <span class="text-gray-600">העלה תמונות</span>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <input type="file" id="maintenanceImages" accept="image/*" multiple class="hidden">
                        </label>
                    </div>
                    <div id="maintenanceImagesPreview" class="mt-3 grid grid-cols-3 gap-2"></div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold">
                        הוסף טיפול
                    </button>
                    <button type="button" onclick="closeMaintenanceModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 font-bold">
                        ביטול
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Car Details Modal -->
    <div id="carDetailsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold" id="detailsPlateNumber"></h2>
                <button onclick="closeCarDetailsModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <div id="carDetailsContent"></div>
                
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h3 class="text-xl font-bold">היסטוריית טיפולים</h3>
                        <div class="flex gap-2">
                            <button onclick="openAppointmentModal()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 flex items-center gap-1 text-sm">
                                📅 קבע פגישה
                            </button>
                            <button onclick="openMaintenanceModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                + הוסף טיפול
                            </button>
                        </div>
                    </div>
                    
                    <div id="maintenanceHistory" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold">📊 לוח בקרה - ניהול רכבים</h2>
                    <button onclick="closeDashboard()" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded">
                        <div class="text-3xl font-bold text-yellow-700" id="waitingCount">0</div>
                        <div class="text-sm text-yellow-600">ממתין לטיפול</div>
                    </div>
                    <div class="bg-blue-100 border-l-4 border-blue-500 p-4 rounded">
                        <div class="text-3xl font-bold text-blue-700" id="inProgressCount">0</div>
                        <div class="text-sm text-blue-600">בטיפול</div>
                    </div>
                    <div class="bg-green-100 border-l-4 border-green-500 p-4 rounded">
                        <div class="text-3xl font-bold text-green-700" id="readyCount">0</div>
                        <div class="text-sm text-green-600">מוכן לאיסוף</div>
                    </div>
                    <div class="bg-gray-100 border-l-4 border-gray-500 p-4 rounded">
                        <div class="text-3xl font-bold text-gray-700" id="completedCount">0</div>
                        <div class="text-sm text-gray-600">הושלם</div>
                    </div>
                </div>
                
                <!-- Kanban Board -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- ממתין לטיפול -->
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-yellow-700 flex items-center gap-2">
                            ⏳ ממתין לטיפול
                        </h3>
                        <div id="waitingColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                    
                    <!-- בטיפול -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-blue-700 flex items-center gap-2">
                            🔧 בטיפול
                        </h3>
                        <div id="inProgressColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                    
                    <!-- מוכן לאיסוף -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-green-700 flex items-center gap-2">
                            ✅ מוכן לאיסוף
                        </h3>
                        <div id="readyColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                    
                    <!-- הושלם -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-gray-700 flex items-center gap-2">
                            🏁 הושלם
                        </h3>
                        <div id="completedColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full">
            <div class="bg-orange-600 text-white p-6 rounded-t-lg">
                <h2 class="text-2xl font-bold">⚙️ הגדרות</h2>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">טלפון חנות חלפים</label>
                    <input type="text" id="sparePartsPhone" 
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-500"
                           placeholder="050-1234567">
                    <p class="text-xs text-gray-500 mt-1">מספר זה ישמש לשליחת הזמנות חלקים בוואטסאפ</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveSettings()" class="flex-1 bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 font-bold">
                        שמור
                    </button>
                    <button onclick="closeSettings()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 font-bold">
                        ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full">
            <div class="bg-teal-600 text-white p-6 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">💾 גיבוי ושחזור</h2>
                    <button onclick="closeBackupModal()" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Backup Section -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">📤 יצירת גיבוי</h3>
                    <p class="text-gray-600 mb-4">שמור את כל הנתונים שלך (רכבים, טיפולים, פגישות) לקובץ JSON</p>
                    
                    <div class="flex gap-3">
                        <button onclick="createBackup()" class="flex-1 bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 font-bold flex items-center justify-center gap-2">
                            <span>💾</span>
                            <span>יצירת גיבוי מלא</span>
                        </button>
                        <button onclick="createBackupWithImages()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold flex items-center justify-center gap-2">
                            <span>📸</span>
                            <span>גיבוי עם תמונות</span>
                        </button>
                    </div>
                    
                    <div id="backupProgress" class="hidden mt-4">
                        <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                            <div id="backupProgressBar" class="bg-teal-600 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="backupProgressText" class="text-center text-sm text-gray-600 mt-2">מכין גיבוי...</p>
                    </div>
                </div>
                
                <hr class="my-6">
                
                <!-- Restore Section -->
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">📥 שחזור מגיבוי</h3>
                    <p class="text-gray-600 mb-4">טען קובץ גיבוי קודם לשחזור הנתונים</p>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="restoreFile" accept=".json" class="hidden" onchange="handleRestoreFile(event)">
                        <label for="restoreFile" class="cursor-pointer">
                            <div class="text-4xl mb-2">📁</div>
                            <div class="text-blue-600 font-bold mb-1">בחר קובץ גיבוי</div>
                            <div class="text-gray-500 text-sm">או גרור קובץ JSON לכאן</div>
                        </label>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mt-4">
                        <div class="flex items-start gap-2">
                            <span class="text-yellow-600">⚠️</span>
                            <div class="text-sm text-yellow-800">
                                <strong>אזהרה:</strong> שחזור מגיבוי ימחק את כל הנתונים הנוכחיים ויחליף אותם בנתונים מהגיבוי!
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-6">
                
                <!-- Last Backup Info -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-600">גיבוי אחרון</div>
                            <div id="lastBackupDate" class="font-bold text-gray-800">טרם בוצע גיבוי</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">סה״כ נתונים</div>
                            <div id="totalDataCount" class="font-bold text-gray-800">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold">📅 יומן פגישות</h2>
                <button onclick="closeCalendarModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-6">
                    <button onclick="previousMonth()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">
                        ←
                    </button>
                    <h3 class="text-xl font-bold" id="currentMonthYear"></h3>
                    <button onclick="nextMonth()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">
                        →
                    </button>
                </div>
                
                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-2 mb-6">
                    <div class="text-center font-bold p-2">א׳</div>
                    <div class="text-center font-bold p-2">ב׳</div>
                    <div class="text-center font-bold p-2">ג׳</div>
                    <div class="text-center font-bold p-2">ד׳</div>
                    <div class="text-center font-bold p-2">ה׳</div>
                    <div class="text-center font-bold p-2">ו׳</div>
                    <div class="text-center font-bold p-2">ש׳</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                
                <!-- Appointments List for Selected Day -->
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-4" id="selectedDayTitle">פגישות היום</h3>
                    <div id="dayAppointments"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-purple-600 text-white p-6 rounded-t-lg">
                <h2 class="text-2xl font-bold">📅 פגישה חדשה</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
                <!-- Left side - Form -->
                <div>
                    <form id="appointmentForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">רכב</label>
                            <select id="appointmentCar" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                                <option value="">בחר רכב...</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">תאריך</label>
                            <input type="date" id="appointmentDate" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">שעה (24 שעות)</label>
                            <input type="time" id="appointmentTime" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">סוג הפגישה</label>
                            <select id="appointmentType" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                                <option value="">בחר סוג...</option>
                                <option value="שירות">שירות / טיפול</option>
                                <option value="תיקון">תיקון</option>
                                <option value="בדיקה">בדיקה תקופתית</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">הערות</label>
                            <textarea id="appointmentNotes" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500" placeholder="הערות נוספות..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="appointmentReminder" class="ml-2">
                                <span class="text-gray-700">שלח תזכורת ווטסאפ ללקוח</span>
                            </label>
                        </div>
                        
                        <div class="flex gap-2">
                            <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">
                                שמור פגישה
                            </button>
                            <button type="button" onclick="closeAppointmentModal()" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">
                                ביטול
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Right side - Mini Calendar -->
                <div class="border-r pr-6">
                    <h3 class="text-lg font-bold mb-4 text-center">פגישות קיימות</h3>
                    
                    <!-- Mini Calendar Navigation -->
                    <div class="flex justify-between items-center mb-4">
                        <button type="button" onclick="previousMonthMini()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            ←
                        </button>
                        <h4 class="font-bold" id="miniMonthYear"></h4>
                        <button type="button" onclick="nextMonthMini()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            →
                        </button>
                    </div>
                    
                    <!-- Mini Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-xs font-bold p-1">א׳</div>
                        <div class="text-center text-xs font-bold p-1">ב׳</div>
                        <div class="text-center text-xs font-bold p-1">ג׳</div>
                        <div class="text-center text-xs font-bold p-1">ד׳</div>
                        <div class="text-center text-xs font-bold p-1">ה׳</div>
                        <div class="text-center text-xs font-bold p-1">ו׳</div>
                        <div class="text-center text-xs font-bold p-1">ש׳</div>
                    </div>
                    <div id="miniCalendarGrid" class="grid grid-cols-7 gap-1 mb-4"></div>
                    
                    <!-- Selected Day Appointments -->
                    <div id="miniDayAppointments" class="text-sm max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdSRfJCoU6xwDych3l_3K_hBZBHOi9jVg",
            authDomain: "garage-17263.firebaseapp.com",
            projectId: "garage-17263",
            storageBucket: "garage-17263.firebasestorage.app",
            messagingSenderId: "332265903935",
            appId: "1:332265903935:web:237c0787a161fd36a7a58a",
            measurementId: "G-KLLCPECCDQ"
        };

        // Initialize Firebase
        let app, db, auth;
        let currentUser = null;
        let cars = [];
        let appointments = [];
        let editingCarId = null;
        let currentCarId = null;
        let editingMaintenanceId = null;
        let editingAppointmentId = null;
        let isRegisterMode = false;
        let maintenanceImages = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let miniMonth = new Date().getMonth();
        let miniYear = new Date().getFullYear();
        let miniSelectedDate = null;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('Firebase initialized with maintenance system!');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('loadingScreen').innerHTML = 
                '<div class="text-center"><p class="text-red-600">שגיאה בטעינת המערכת</p></div>';
        }

        // Compress Image Function
        async function compressImage(file, maxSizeKB = 700) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 1200;
                        if (width > height && width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.8;
                        let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        while (compressedDataUrl.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) {
                            quality -= 0.1;
                            compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Calculate Total Cost
        function calculateTotalCost() {
            const partsCost = parseFloat(document.getElementById('partsCost').value) || 0;
            const laborCost = parseFloat(document.getElementById('laborCost').value) || 0;
            const otherCost = parseFloat(document.getElementById('otherCost').value) || 0;
            const total = partsCost + laborCost + otherCost;
            document.getElementById('totalCostDisplay').textContent = total.toFixed(2);
            return total;
        }

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                await loadUserName();
                loadCars();
                loadAppointments();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
            
            document.getElementById('loadingScreen').classList.add('hidden');
        });

        // Load User Name
        async function loadUserName() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists && userDoc.data().displayName) {
                    document.getElementById('userName').textContent = userDoc.data().displayName;
                } else {
                    document.getElementById('userName').textContent = currentUser.email.split('@')[0];
                }
            } catch (error) {
                console.error('Error loading user name:', error);
                document.getElementById('userName').textContent = currentUser.email.split('@')[0];
            }
        }

        // Edit User Name
        function editUserName() {
            const currentName = document.getElementById('userName').textContent;
            const newName = prompt('הכנס שם חדש:', currentName);
            
            if (newName && newName.trim() !== '' && newName !== currentName) {
                saveUserName(newName.trim());
            }
        }

        // Save User Name
        async function saveUserName(name) {
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    displayName: name,
                    email: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                document.getElementById('userName').textContent = name;
                alert('השם עודכן בהצלחה!');
            } catch (error) {
                console.error('Error saving user name:', error);
                alert('שגיאה בשמירת השם');
            }
        }

        // Toggle Auth Mode
        document.getElementById('toggleAuth').addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            const authBtn = document.getElementById('authBtn');
            const toggleLink = document.getElementById('toggleAuth');
            
            if (isRegisterMode) {
                authBtn.textContent = 'הירשם';
                toggleLink.textContent = 'יש לך חשבון? התחבר';
            } else {
                authBtn.textContent = 'התחבר';
                toggleLink.textContent = 'אין לך חשבון? הירשם';
            }
        });

        // Login/Register Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authBtn = document.getElementById('authBtn');
            
            authBtn.disabled = true;
            authBtn.textContent = 'מעבד...';
            
            try {
                if (isRegisterMode) {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showMessage('החשבון נוצר בהצלחה!', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    showMessage('התחברת בהצלחה!', 'success');
                }
            } catch (error) {
                console.error('Auth error:', error);
                let message = 'שגיאה';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        message = 'המשתמש לא קיים';
                        break;
                    case 'auth/wrong-password':
                        message = 'סיסמה שגויה';
                        break;
                    case 'auth/email-already-in-use':
                        message = 'האימייל כבר בשימוש';
                        break;
                    case 'auth/weak-password':
                        message = 'הסיסמה חלשה מדי';
                        break;
                    case 'auth/invalid-email':
                        message = 'אימייל לא תקין';
                        break;
                }
                
                showMessage(message, 'error');
            } finally {
                authBtn.disabled = false;
                authBtn.textContent = isRegisterMode ? 'הירשם' : 'התחבר';
            }
        });

        // Load Cars
        async function loadCars() {
            try {
                const snapshot = await db.collection('cars')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                cars = [];
                snapshot.forEach(doc => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                
                displayCars();
            } catch (error) {
                console.error('Error loading cars:', error);
            }
        }

        // Display Cars
        function displayCars() {
            const grid = document.getElementById('carsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (cars.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            grid.innerHTML = cars.map(car => `
                <div class="bg-white rounded-lg shadow p-4 car-card" data-search="${car.plateNumber} ${car.ownerName || ''}">
                    ${car.imageUrl ? 
                        `<img src="${car.imageUrl}" class="w-full h-40 object-cover rounded mb-3 cursor-pointer" onclick="viewCarDetails('${car.id}')">` : 
                        `<div class="w-full h-40 bg-gray-200 rounded mb-3 flex items-center justify-center text-gray-400 cursor-pointer" onclick="viewCarDetails('${car.id}')">אין תמונה</div>`
                    }
                    <h3 class="font-bold text-lg cursor-pointer hover:text-blue-600" onclick="viewCarDetails('${car.id}')">${car.plateNumber}</h3>
                    ${car.ownerName ? `<p class="text-gray-600">${car.ownerName}</p>` : ''}
                    ${car.phone ? `<p class="text-sm">📞 ${car.phone}</p>` : ''}
                    ${car.carType ? `<p class="text-sm">🚗 ${car.carType}</p>` : ''}
                    ${car.model ? `<p class="text-sm">📋 ${car.model}</p>` : ''}
                    ${car.year ? `<p class="text-sm">📅 ${car.year}</p>` : ''}
                    
                    <div class="mt-3 flex gap-2 flex-wrap">
                        <button onclick="viewCarDetails('${car.id}')" class="text-green-600 hover:underline text-sm">📋 פרטים</button>
                        <button onclick="editCar('${car.id}')" class="text-blue-600 hover:underline text-sm">עריכה</button>
                        <button onclick="deleteCar('${car.id}')" class="text-red-600 hover:underline text-sm">מחיקה</button>
                    </div>
                </div>
            `).join('');
        }

        // View Car Details
        async function viewCarDetails(carId) {
            currentCarId = carId;
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            // Display car details
            document.getElementById('detailsPlateNumber').textContent = car.plateNumber;
            
            // WhatsApp and Call buttons
            const phoneButtons = car.phone ? `
                <div class="mb-6 flex flex-wrap gap-2">
                    <a href="tel:${car.phone}" class="flex-1 min-w-[200px] bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 text-center font-bold">
                        📞 התקשר ל${car.ownerName || 'בעלים'}
                    </a>
                    <a href="https://wa.me/972${car.phone.replace(/^0/, '')}?text=${encodeURIComponent('שלום ' + (car.ownerName || '') + ', רכבך ' + car.plateNumber + ' נכנס לטיפול במוסך. נעדכן אותך בהמשך.')}" 
                       target="_blank" 
                       class="flex-1 min-w-[200px] bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 text-center font-bold">
                        💬 נכנס לטיפול
                    </a>
                    <a href="https://wa.me/972${car.phone.replace(/^0/, '')}?text=${encodeURIComponent('שלום ' + (car.ownerName || '') + ', רכבך ' + car.plateNumber + ' מוכן ומחכה לאיסוף. ניתן לבוא לקחת את הרכב.')}" 
                       target="_blank" 
                       class="flex-1 min-w-[200px] bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 text-center font-bold">
                        ✅ מוכן לאיסוף
                    </a>
                    <a href="https://wa.me/972${car.phone.replace(/^0/, '')}?text=${encodeURIComponent('שלום ' + (car.ownerName || '') + ', רכבך ' + car.plateNumber + ' נמסר בהצלחה. תודה שבחרת בשירותינו!')}" 
                       target="_blank" 
                       class="flex-1 min-w-[200px] bg-purple-500 text-white px-4 py-3 rounded-lg hover:bg-purple-600 text-center font-bold">
                        🎉 נמסר בהצלחה
                    </a>
                </div>
            ` : '<div class="mb-6 p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded">אין מספר טלפון - אנא הוסף מספר כדי להשתמש בתכונות התקשורת</div>';
            
            document.getElementById('carDetailsContent').innerHTML = `
                ${phoneButtons}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    ${car.imageUrl ? `
                        <div class="col-span-2">
                            <img src="${car.imageUrl}" class="w-full max-h-64 object-contain rounded">
                        </div>
                    ` : ''}
                    ${car.ownerName ? `<div><span class="font-bold">שם הבעלים:</span> ${car.ownerName}</div>` : ''}
                    ${car.phone ? `<div><span class="font-bold">טלפון:</span> ${car.phone}</div>` : ''}
                    ${car.carType ? `<div><span class="font-bold">סוג רכב:</span> ${car.carType}</div>` : ''}
                    ${car.model ? `<div><span class="font-bold">דגם:</span> ${car.model}</div>` : ''}
                    ${car.year ? `<div><span class="font-bold">שנת ייצור:</span> ${car.year}</div>` : ''}
                    ${car.vinCode ? `<div><span class="font-bold">קוד רכב (VIN):</span> ${car.vinCode}</div>` : ''}
                    ${car.immobilizerCode ? `<div class="bg-yellow-50 border border-yellow-300 p-2 rounded"><span class="font-bold">🔑 קוד התנעה:</span> <span class="font-mono">${car.immobilizerCode}</span></div>` : ''}
                    ${car.engineType ? `<div><span class="font-bold">סוג מנוע:</span> ${car.engineType}</div>` : ''}
                    ${car.enginePower ? `<div class="col-span-2"><span class="font-bold">הספק מנוע:</span> ${car.enginePower}</div>` : ''}
                </div>
            `;
            
            // Load maintenance history
            await loadMaintenanceHistory(carId);
            
            document.getElementById('carDetailsModal').classList.remove('hidden');
        }

        // Load Maintenance History
        async function loadMaintenanceHistory(carId) {
            try {
                // Get car data first
                const car = cars.find(c => c.id === carId);
                
                const snapshot = await db.collection('maintenance')
                    .where('carId', '==', carId)
                    .get();
                
                const maintenanceList = [];
                snapshot.forEach(doc => {
                    maintenanceList.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by createdAt in JavaScript (no Firestore index needed)
                maintenanceList.sort((a, b) => {
                    const dateA = a.createdAt?.toMillis() || 0;
                    const dateB = b.createdAt?.toMillis() || 0;
                    return dateB - dateA; // Newest first
                });
                
                const historyDiv = document.getElementById('maintenanceHistory');
                
                if (maintenanceList.length === 0) {
                    historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">אין טיפולים עדיין</p>';
                    return;
                }
                
                historyDiv.innerHTML = maintenanceList.map(m => {
                    return `
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    ${m.date ? `<div class="font-bold text-lg mb-1">📅 ${new Date(m.date).toLocaleDateString('he-IL')}</div>` : ''}
                                    ${m.kilometers ? `<div class="text-sm text-gray-600">🚗 ${m.kilometers} ק״מ</div>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    ${m.partName && car ? `<button onclick="orderSparePart('${m.partName.replace(/'/g, "\\'")}', '${car.carType || ''}', '${car.model || ''}', '${car.year || ''}')" class="text-green-600 hover:underline text-sm">📦 הזמן חלק</button>` : ''}
                                    <button onclick="printMaintenance('${m.id}')" class="text-purple-600 hover:underline text-sm">🖨️ הדפס</button>
                                    <button onclick="editMaintenance('${m.id}')" class="text-blue-600 hover:underline text-sm">עריכה</button>
                                    <button onclick="deleteMaintenance('${m.id}')" class="text-red-600 hover:underline text-sm">מחיקה</button>
                                </div>
                            </div>
                            
                            ${m.partName ? `<p class="mb-2"><strong>🔧 חלק:</strong> ${m.partName}</p>` : ''}
                            ${m.workDescription ? `<p class="mb-2"><strong>תיאור:</strong> ${m.workDescription}</p>` : ''}
                            
                            ${m.totalCost > 0 ? `
                                <div class="text-lg font-bold text-green-700 mb-2">
                                    💰 ${m.totalCost.toFixed(2)} ₪
                                </div>
                            ` : ''}
                            
                            ${m.images && m.images.length > 0 ? `
                                <div class="grid grid-cols-3 gap-2 mt-2">
                                    ${m.images.map(img => `<img src="${img}" class="w-full h-24 object-cover rounded cursor-pointer" onclick="window.open('${img}')">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Close Car Details Modal
        function closeCarDetailsModal() {
            document.getElementById('carDetailsModal').classList.add('hidden');
            currentCarId = null;
        }

        // Open Car Modal
        function openCarModal() {
            editingCarId = null;
            document.getElementById('modalTitle').textContent = 'הוסף רכב';
            document.getElementById('carForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Close Car Modal
        function closeCarModal() {
            document.getElementById('carModal').classList.add('hidden');
            editingCarId = null;
        }

        // Edit Car
        function editCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            editingCarId = carId;
            document.getElementById('modalTitle').textContent = 'ערוך רכב';
            document.getElementById('plateNumber').value = car.plateNumber || '';
            document.getElementById('ownerName').value = car.ownerName || '';
            document.getElementById('phone').value = car.phone || '';
            document.getElementById('carType').value = car.carType || '';
            document.getElementById('model').value = car.model || '';
            document.getElementById('year').value = car.year || '';
            document.getElementById('vinCode').value = car.vinCode || '';
            document.getElementById('immobilizerCode').value = car.immobilizerCode || '';
            document.getElementById('engineType').value = car.engineType || '';
            document.getElementById('enginePower').value = car.enginePower || '';
            document.getElementById('carStatus').value = car.carStatus || 'waiting';
            
            if (car.imageUrl) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${car.imageUrl}" class="w-32 h-32 object-cover rounded">`;
            }
            
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Car Form Submit
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'שומר...';
            
            try {
                const carData = {
                    plateNumber: document.getElementById('plateNumber').value.trim(),
                    ownerName: document.getElementById('ownerName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    carType: document.getElementById('carType').value.trim(),
                    model: document.getElementById('model').value.trim(),
                    year: document.getElementById('year').value.trim(),
                    vinCode: document.getElementById('vinCode').value.trim(),
                    immobilizerCode: document.getElementById('immobilizerCode').value.trim(),
                    engineType: document.getElementById('engineType').value.trim(),
                    enginePower: document.getElementById('enginePower').value.trim(),
                    carStatus: document.getElementById('carStatus').value || 'waiting',
                    userId: currentUser.uid,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const imageFile = document.getElementById('carImage').files[0];
                if (imageFile) {
                    try {
                        submitBtn.textContent = 'דוחס תמונה...';
                        const compressedImage = await compressImage(imageFile, 700);
                        carData.imageUrl = compressedImage;
                        submitBtn.textContent = 'שומר נתונים...';
                    } catch (imageError) {
                        console.error('Image compression error:', imageError);
                        alert('שגיאה בעיבוד התמונה. אנא נסה שוב.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                } else if (editingCarId) {
                    const existingCar = cars.find(c => c.id === editingCarId);
                    if (existingCar && existingCar.imageUrl) {
                        carData.imageUrl = existingCar.imageUrl;
                    }
                }
                
                if (editingCarId) {
                    await db.collection('cars').doc(editingCarId).update(carData);
                    alert('הרכב עודכן בהצלחה!');
                } else {
                    carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('cars').add(carData);
                    alert('הרכב נוסף בהצלחה!');
                }
                
                document.getElementById('carForm').reset();
                document.getElementById('imagePreview').innerHTML = '';
                closeCarModal();
                await loadCars();
                
            } catch (error) {
                console.error('Error saving car:', error);
                alert('שגיאה: ' + (error.message || 'לא ניתן לשמור את הנתונים'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Delete Car
        async function deleteCar(carId) {
            if (!confirm('האם למחוק את הרכב? גם כל הטיפולים יימחקו.')) return;
            
            try {
                // Delete all maintenance records
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('carId', '==', carId)
                    .get();
                
                const deletePromises = [];
                maintenanceSnapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                await Promise.all(deletePromises);
                
                // Delete car
                await db.collection('cars').doc(carId).delete();
                alert('הרכב נמחק בהצלחה');
                await loadCars();
            } catch (error) {
                console.error('Error deleting car:', error);
                alert('שגיאה במחיקת הרכב');
            }
        }

        // Open Maintenance Modal
        function openMaintenanceModal() {
            if (!currentCarId) {
                alert('אנא בחר רכב תחילה');
                return;
            }
            
            editingMaintenanceId = null;
            maintenanceImages = [];
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenanceImagesPreview').innerHTML = '';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('maintenanceDate').value = today;
            
            document.getElementById('maintenanceModal').classList.remove('hidden');
        }

        // Close Maintenance Modal
        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.add('hidden');
            editingMaintenanceId = null;
            maintenanceImages = [];
        }

        // Edit Maintenance
        async function editMaintenance(maintenanceId) {
            try {
                const doc = await db.collection('maintenance').doc(maintenanceId).get();
                if (!doc.exists) return;
                
                const m = doc.data();
                editingMaintenanceId = maintenanceId;
                
                document.getElementById('maintenanceDate').value = m.date || '';
                document.getElementById('kilometers').value = m.kilometers || '';
                document.getElementById('partName').value = m.partName || '';
                document.getElementById('workDescription').value = m.workDescription || '';
                document.getElementById('totalCost').value = m.totalCost || '';
                
                maintenanceImages = m.images || [];
                
                if (maintenanceImages.length > 0) {
                    document.getElementById('maintenanceImagesPreview').innerHTML = 
                        maintenanceImages.map((img, i) => `
                            <div class="relative">
                                <img src="${img}" class="w-full h-24 object-cover rounded">
                                <button type="button" onclick="removeMaintenanceImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs">×</button>
                            </div>
                        `).join('');
                }
                
                document.getElementById('maintenanceModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Delete Maintenance
        async function deleteMaintenance(maintenanceId) {
            if (!confirm('האם למחוק את הטיפול?')) return;
            
            try {
                await db.collection('maintenance').doc(maintenanceId).delete();
                alert('הטיפול נמחק בהצלחה');
                await loadMaintenanceHistory(currentCarId);
            } catch (error) {
                console.error('Error deleting maintenance:', error);
                alert('שגיאה במחיקת הטיפול');
            }
        }

        // Print Maintenance
        async function printMaintenance(maintenanceId) {
            try {
                const doc = await db.collection('maintenance').doc(maintenanceId).get();
                if (!doc.exists) return;
                
                const m = doc.data();
                const car = cars.find(c => c.id === currentCarId);
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="he" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>דוח טיפול - ${car.plateNumber}</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                direction: rtl;
                                padding: 20px;
                                max-width: 800px;
                                margin: 0 auto;
                            }
                            .header {
                                text-align: center;
                                border-bottom: 3px solid #333;
                                padding-bottom: 20px;
                                margin-bottom: 30px;
                            }
                            .header h1 {
                                margin: 0;
                                font-size: 32px;
                            }
                            .header p {
                                margin: 5px 0;
                                color: #666;
                            }
                            .section {
                                margin-bottom: 20px;
                            }
                            .section-title {
                                font-weight: bold;
                                font-size: 18px;
                                border-bottom: 2px solid #eee;
                                padding-bottom: 5px;
                                margin-bottom: 10px;
                            }
                            .info-row {
                                margin: 10px 0;
                                font-size: 16px;
                            }
                            .info-label {
                                font-weight: bold;
                                display: inline-block;
                                width: 150px;
                            }
                            .cost {
                                font-size: 28px;
                                font-weight: bold;
                                color: #22c55e;
                                text-align: center;
                                padding: 20px;
                                border: 2px solid #22c55e;
                                border-radius: 10px;
                                margin: 20px 0;
                            }
                            .footer {
                                margin-top: 50px;
                                text-align: center;
                                color: #666;
                                font-size: 14px;
                                border-top: 1px solid #eee;
                                padding-top: 20px;
                            }
                            @media print {
                                body {
                                    padding: 0;
                                }
                                .no-print {
                                    display: none;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>דוח טיפול</h1>
                            <p>${new Date().toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">פרטי רכב</div>
                            <div class="info-row">
                                <span class="info-label">מספר רישוי:</span>
                                <span>${car.plateNumber}</span>
                            </div>
                            ${car.ownerName ? `
                                <div class="info-row">
                                    <span class="info-label">שם הבעלים:</span>
                                    <span>${car.ownerName}</span>
                                </div>
                            ` : ''}
                            ${car.phone ? `
                                <div class="info-row">
                                    <span class="info-label">טלפון:</span>
                                    <span>${car.phone}</span>
                                </div>
                            ` : ''}
                            ${car.carType ? `
                                <div class="info-row">
                                    <span class="info-label">סוג רכב:</span>
                                    <span>${car.carType}</span>
                                </div>
                            ` : ''}
                            ${car.model ? `
                                <div class="info-row">
                                    <span class="info-label">דגם:</span>
                                    <span>${car.model}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${m.workDescription ? `
                            <div class="section">
                                <div class="section-title">תיאור העבודה</div>
                                <div class="info-row">${m.workDescription}</div>
                            </div>
                        ` : ''}
                        
                        ${m.parts ? `
                            <div class="section">
                                <div class="section-title">חלקי חילוף</div>
                                <div class="info-row">${m.parts}</div>
                            </div>
                        ` : ''}
                        
                        ${m.notes ? `
                            <div class="section">
                                <div class="section-title">הערות</div>
                                <div class="info-row">${m.notes}</div>
                            </div>
                        ` : ''}
                        
                        ${m.totalCost > 0 ? `
                            <div class="cost">
                                סה"כ לתשלום: ${m.totalCost.toFixed(2)} ₪
                            </div>
                        ` : ''}
                        
                        <div class="footer">
                            <p>תודה שבחרת בשירותינו!</p>
                            <p>דוח זה הופק בתאריך ${new Date().toLocaleDateString('he-IL')}</p>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 30px;">
                            <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                🖨️ הדפס
                            </button>
                            <button onclick="window.close()" style="padding: 10px 30px; font-size: 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                סגור
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
            } catch (error) {
                console.error('Error printing maintenance:', error);
                alert('שגיאה בהדפסת הטיפול');
            }
        }

        // Remove Maintenance Image
        function removeMaintenanceImage(index) {
            maintenanceImages.splice(index, 1);
            document.getElementById('maintenanceImagesPreview').innerHTML = 
                maintenanceImages.map((img, i) => `
                    <div class="relative">
                        <img src="${img}" class="w-full h-24 object-cover rounded">
                        <button type="button" onclick="removeMaintenanceImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs">×</button>
                    </div>
                `).join('');
        }

        // Maintenance Form Submit
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'שומר...';
            
            try {
                const maintenanceData = {
                    carId: currentCarId,
                    userId: currentUser.uid,
                    date: document.getElementById('maintenanceDate').value,
                    kilometers: document.getElementById('kilometers').value,
                    partName: document.getElementById('partName').value,
                    workDescription: document.getElementById('workDescription').value,
                    totalCost: parseFloat(document.getElementById('totalCost').value) || 0,
                    images: maintenanceImages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Handle new images
                const imageFiles = document.getElementById('maintenanceImages').files;
                if (imageFiles.length > 0) {
                    submitBtn.textContent = 'דוחס תמונות...';
                    
                    for (let i = 0; i < Math.min(imageFiles.length, 5); i++) {
                        try {
                            const compressed = await compressImage(imageFiles[i], 500);
                            maintenanceImages.push(compressed);
                        } catch (err) {
                            console.error('Image compression error:', err);
                        }
                    }
                    
                    maintenanceData.images = maintenanceImages;
                }
                
                submitBtn.textContent = 'שומר נתונים...';
                
                if (editingMaintenanceId) {
                    await db.collection('maintenance').doc(editingMaintenanceId).update(maintenanceData);
                    alert('הטיפול עודכן בהצלחה!');
                } else {
                    maintenanceData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('maintenance').add(maintenanceData);
                    alert('הטיפול נוסף בהצלחה!');
                }
                
                closeMaintenanceModal();
                await loadMaintenanceHistory(currentCarId);
                
            } catch (error) {
                console.error('Error saving maintenance:', error);
                alert('שגיאה: ' + (error.message || 'לא ניתן לשמור את הנתונים'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Search Cars
        function searchCars() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const cards = document.querySelectorAll('.car-card');
            
            cards.forEach(card => {
                const text = card.dataset.search.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Export CSV
        function exportCSV() {
            if (cars.length === 0) {
                alert('אין נתונים לייצוא');
                return;
            }
            
            let csv = 'מספר רישוי,שם בעלים,טלפון,סוג,דגם,שנה\n';
            cars.forEach(car => {
                csv += `${car.plateNumber},${car.ownerName || ''},${car.phone || ''},${car.carType || ''},${car.model || ''},${car.year || ''}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `cars_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Sign Out
        async function signOut() {
            if (confirm('האם לצאת מהמערכת?')) {
                await auth.signOut();
            }
        }

        // Show Message
        function showMessage(message, type) {
            const errorDiv = document.getElementById('errorMsg');
            const successDiv = document.getElementById('successMsg');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
            }
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }, 5000);
        }

        // Image Preview
        document.getElementById('carImage').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const previewDiv = document.getElementById('imagePreview');
            
            if (file) {
                if (!file.type.match(/image\/(jpeg|jpg|png|gif)/)) {
                    alert('פורמט לא נתמך. השתמש ב-JPG או PNG');
                    e.target.value = '';
                    previewDiv.innerHTML = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const originalSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    const compressed = await compressImage(file, 700);
                    const compressedSizeKB = (compressed.length / 1024 / 1.37).toFixed(0);
                    
                    previewDiv.innerHTML = `
                        <img src="${compressed}" class="w-32 h-32 object-cover rounded mt-2 border">
                        <p class="text-xs text-green-600 mt-1">✓ דחוס אוטומטית</p>
                        <p class="text-xs text-gray-500">${originalSizeMB}MB → ${compressedSizeKB}KB</p>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.innerHTML = '';
            }
        });

        // Maintenance Images Preview
        document.getElementById('maintenanceImages').addEventListener('change', async (e) => {
            const files = e.target.files;
            const previewDiv = document.getElementById('maintenanceImagesPreview');
            
            if (files.length > 0) {
                const previews = [];
                for (let i = 0; i < Math.min(files.length, 5); i++) {
                    const file = files[i];
                    if (file.type.match(/image\/(jpeg|jpg|png|gif)/)) {
                        const reader = new FileReader();
                        const preview = await new Promise((resolve) => {
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        previews.push(preview);
                    }
                }
                
                previewDiv.innerHTML = previews.map((img, i) => `
                    <img src="${img}" class="w-full h-24 object-cover rounded">
                `).join('');
            }
        });

        // ==========================================
        // APPOINTMENTS SYSTEM
        // ==========================================

        // Load Appointments from Firebase
        async function loadAppointments() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sort by date locally
                appointments.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateA - dateB;
                });
                
                console.log('Loaded appointments:', appointments.length);
            } catch (error) {
                console.error('Error loading appointments:', error);
                alert('שגיאה בטעינת פגישות: ' + error.message);
            }
        }

        // Open Calendar Modal
        async function openCalendarModal() {
            document.getElementById('calendarModal').classList.remove('hidden');
            await loadAppointments(); // Reload appointments
            renderCalendar();
        }

        // Close Calendar Modal
        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.add('hidden');
        }

        // Open Appointment Modal
        function openAppointmentModal() {
            editingAppointmentId = null;
            document.getElementById('appointmentForm').reset();
            
            // Populate car dropdown
            const carSelect = document.getElementById('appointmentCar');
            carSelect.innerHTML = '<option value="">בחר רכב...</option>';
            
            cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.id;
                option.textContent = `${car.plateNumber} - ${car.ownerName}`;
                if (currentCarId && car.id === currentCarId) {
                    option.selected = true;
                }
                carSelect.appendChild(option);
            });
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').value = today;
            miniSelectedDate = today;
            
            // Reset mini calendar to current month
            miniMonth = new Date().getMonth();
            miniYear = new Date().getFullYear();
            
            document.getElementById('appointmentModal').classList.remove('hidden');
            renderMiniCalendar();
        }

        // Close Appointment Modal
        function closeAppointmentModal() {
            document.getElementById('appointmentModal').classList.add('hidden');
            editingAppointmentId = null;
        }

        // Previous Month for Mini Calendar
        function previousMonthMini() {
            miniMonth--;
            if (miniMonth < 0) {
                miniMonth = 11;
                miniYear--;
            }
            renderMiniCalendar();
        }

        // Next Month for Mini Calendar
        function nextMonthMini() {
            miniMonth++;
            if (miniMonth > 11) {
                miniMonth = 0;
                miniYear++;
            }
            renderMiniCalendar();
        }

        // Render Mini Calendar
        function renderMiniCalendar() {
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            document.getElementById('miniMonthYear').textContent = `${monthNames[miniMonth]} ${miniYear}`;
            
            const firstDay = new Date(miniYear, miniMonth, 1).getDay();
            const daysInMonth = new Date(miniYear, miniMonth + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('miniCalendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-1';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add days of month
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${miniYear}-${String(miniMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = appointments.filter(apt => apt.date === dateStr);
                
                const dayCell = document.createElement('div');
                
                // Build class name
                let className = 'p-1 text-center text-sm border rounded cursor-pointer hover:bg-blue-50';
                
                // Today gets purple border
                if (dateStr === todayStr) {
                    className += ' border-purple-500 bg-purple-50';
                }
                
                // Has appointments - show red dot
                if (dayAppointments.length > 0) {
                    className += ' font-bold text-red-600';
                }
                
                // Selected date
                if (dateStr === miniSelectedDate) {
                    className += ' bg-blue-200';
                }
                
                dayCell.className = className;
                dayCell.onclick = () => selectMiniDate(dateStr);
                
                dayCell.innerHTML = `<div>${day}</div>`;
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Show appointments for selected date
            showMiniDayAppointments();
        }

        // Select date in mini calendar
        function selectMiniDate(dateStr) {
            miniSelectedDate = dateStr;
            document.getElementById('appointmentDate').value = dateStr;
            renderMiniCalendar();
        }

        // Show appointments for selected day in mini calendar
        function showMiniDayAppointments() {
            const container = document.getElementById('miniDayAppointments');
            
            if (!miniSelectedDate) {
                container.innerHTML = '<p class="text-gray-500 text-center py-2">בחר תאריך</p>';
                return;
            }
            
            const date = new Date(miniSelectedDate);
            const dateFormatted = date.toLocaleDateString('he-IL', { day: 'numeric', month: 'long' });
            
            const dayAppointments = appointments.filter(apt => apt.date === miniSelectedDate).sort((a, b) => a.time.localeCompare(b.time));
            
            if (dayAppointments.length === 0) {
                container.innerHTML = `<p class="text-green-600 text-center py-2">✓ ${dateFormatted} - ללא פגישות</p>`;
                return;
            }
            
            container.innerHTML = `
                <div class="font-bold mb-2 text-red-600">⚠️ פגישות ב-${dateFormatted}:</div>
                ${dayAppointments.map(apt => `
                    <div class="border-r-4 border-red-500 bg-red-50 p-2 mb-2 rounded">
                        <div class="font-bold">${apt.time} - ${apt.plateNumber}</div>
                        <div class="text-xs text-gray-600">${apt.type}</div>
                    </div>
                `).join('')}
            `;
        }

        // Listen to date changes in appointment form
        document.getElementById('appointmentDate').addEventListener('change', (e) => {
            miniSelectedDate = e.target.value;
            renderMiniCalendar();
        });

        // Save Appointment
        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const carId = document.getElementById('appointmentCar').value;
            const car = cars.find(c => c.id === carId);
            
            const appointmentData = {
                userId: currentUser.uid,
                carId: carId,
                plateNumber: car.plateNumber,
                ownerName: car.ownerName,
                phone: car.phone || '',
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                type: document.getElementById('appointmentType').value,
                notes: document.getElementById('appointmentNotes').value,
                reminder: document.getElementById('appointmentReminder').checked,
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editingAppointmentId) {
                    await db.collection('appointments').doc(editingAppointmentId).update(appointmentData);
                    console.log('Appointment updated:', editingAppointmentId);
                } else {
                    const docRef = await db.collection('appointments').add(appointmentData);
                    console.log('Appointment created:', docRef.id);
                }
                
                await loadAppointments();
                console.log('Appointments reloaded. Total:', appointments.length);
                closeAppointmentModal();
                
                // Refresh calendar if it's open
                const calendarModal = document.getElementById('calendarModal');
                if (calendarModal && !calendarModal.classList.contains('hidden')) {
                    renderCalendar();
                }
                
                // Send WhatsApp reminder if checked
                if (appointmentData.reminder && appointmentData.phone) {
                    sendAppointmentReminder(appointmentData);
                }
                
                alert('הפגישה נשמרה בהצלחה!');
            } catch (error) {
                console.error('Error saving appointment:', error);
                alert('שגיאה בשמירת הפגישה: ' + error.message);
            }
        });

        // Send WhatsApp Reminder
        function sendAppointmentReminder(appointment) {
            const phone = appointment.phone.replace(/^0/, '972');
            const date = new Date(appointment.date).toLocaleDateString('he-IL');
            const message = `שלום ${appointment.ownerName},\n\nמזכירים לך על פגישה במוסך:\n📅 תאריך: ${date}\n⏰ שעה: ${appointment.time}\n🚗 רכב: ${appointment.plateNumber}\n📋 סוג: ${appointment.type}\n\nנתראה!`;
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Previous Month
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // Next Month
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // Render Calendar
        function renderCalendar() {
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            document.getElementById('currentMonthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-2';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add days of month
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = appointments.filter(apt => apt.date === dateStr);
                
                const dayCell = document.createElement('div');
                
                // Build class name based on conditions
                let className = 'p-2 border rounded cursor-pointer hover:bg-blue-50';
                
                // Today gets purple border and background
                if (dateStr === todayStr) {
                    className += ' border-purple-500 border-2 bg-purple-50';
                }
                
                // Selected date gets blue background
                if (dateStr === selectedDate && dateStr !== todayStr) {
                    className += ' bg-blue-200';
                }
                
                // If selected date is today, show both (purple border + blue background)
                if (dateStr === selectedDate && dateStr === todayStr) {
                    className += ' bg-blue-200';
                }
                
                dayCell.className = className;
                dayCell.onclick = () => selectDate(dateStr);
                
                dayCell.innerHTML = `
                    <div class="text-center font-bold">${day}</div>
                    ${dayAppointments.length > 0 ? `<div class="text-xs text-purple-600 text-center">${dayAppointments.length} פגישות</div>` : ''}
                `;
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Show selected date or today's appointments by default
            if (!selectedDate) {
                selectDate(todayStr);
            } else {
                // Just update the display without changing selectedDate
                const date = new Date(selectedDate);
                const dateFormatted = date.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('selectedDayTitle').textContent = `פגישות ליום ${dateFormatted}`;
                
                const dayAppointments = appointments.filter(apt => apt.date === selectedDate).sort((a, b) => a.time.localeCompare(b.time));
                const container = document.getElementById('dayAppointments');
                
                if (dayAppointments.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">אין פגישות מתוכננות ליום זה</p>';
                } else {
                    container.innerHTML = dayAppointments.map(apt => `
                        <div class="border rounded-lg p-4 mb-3 bg-gray-50">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-bold text-lg">${apt.time} - ${apt.type}</div>
                                    <div class="text-gray-700">🚗 ${apt.plateNumber} - ${apt.ownerName}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editAppointment('${apt.id}')" class="text-blue-600 hover:text-blue-800">✏️</button>
                                    <button onclick="deleteAppointment('${apt.id}')" class="text-red-600 hover:text-red-800">🗑️</button>
                                </div>
                            </div>
                            ${apt.notes ? `<div class="text-sm text-gray-600 mt-2">📝 ${apt.notes}</div>` : ''}
                            ${apt.phone ? `<button onclick="sendAppointmentReminder(${JSON.stringify(apt).replace(/"/g, '&quot;')})" class="mt-2 text-sm text-green-600 hover:text-green-800">📱 שלח תזכורת ווטסאפ</button>` : ''}
                        </div>
                    `).join('');
                }
            }
        }

        // Select Date
        function selectDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar(); // Re-render to update the purple highlight
        }

        // Edit Appointment
        async function editAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            editingAppointmentId = appointmentId;
            
            document.getElementById('appointmentCar').value = appointment.carId;
            document.getElementById('appointmentDate').value = appointment.date;
            document.getElementById('appointmentTime').value = appointment.time;
            document.getElementById('appointmentType').value = appointment.type;
            document.getElementById('appointmentNotes').value = appointment.notes || '';
            document.getElementById('appointmentReminder').checked = appointment.reminder || false;
            
            document.getElementById('appointmentModal').classList.remove('hidden');
        }

        // Delete Appointment
        async function deleteAppointment(appointmentId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק פגישה זו?')) return;
            
            try {
                await db.collection('appointments').doc(appointmentId).delete();
                await loadAppointments();
                renderCalendar();
                alert('הפגישה נמחקה בהצלחה');
            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('שגיאה במחיקת הפגישה');
            }
        }

        // ==========================================
        // DASHBOARD FUNCTIONS
        // ==========================================

        // Open Dashboard
        function openDashboard() {
            document.getElementById('dashboardModal').classList.remove('hidden');
            renderDashboard();
        }

        // Close Dashboard
        function closeDashboard() {
            document.getElementById('dashboardModal').classList.add('hidden');
        }

        // Render Dashboard
        function renderDashboard() {
            // Count cars by status
            const waiting = cars.filter(c => c.carStatus === 'waiting' || !c.carStatus);
            const inProgress = cars.filter(c => c.carStatus === 'in_progress');
            const ready = cars.filter(c => c.carStatus === 'ready');
            const completed = cars.filter(c => c.carStatus === 'completed');
            
            // Update counters
            document.getElementById('waitingCount').textContent = waiting.length;
            document.getElementById('inProgressCount').textContent = inProgress.length;
            document.getElementById('readyCount').textContent = ready.length;
            document.getElementById('completedCount').textContent = completed.length;
            
            // Render columns
            renderDashboardColumn('waitingColumn', waiting, 'waiting');
            renderDashboardColumn('inProgressColumn', inProgress, 'in_progress');
            renderDashboardColumn('readyColumn', ready, 'ready');
            renderDashboardColumn('completedColumn', completed, 'completed');
        }

        // Render Dashboard Column
        function renderDashboardColumn(columnId, carsList, status) {
            const column = document.getElementById(columnId);
            
            if (carsList.length === 0) {
                column.innerHTML = '<p class="text-gray-400 text-center py-4 text-sm">אין רכבים</p>';
                return;
            }
            
            column.innerHTML = carsList.map(car => `
                <div class="bg-white rounded-lg p-3 shadow hover:shadow-md transition cursor-pointer border-r-4 ${getStatusColor(status)}" 
                     onclick="openCarDetailsModal('${car.id}')">
                    <div class="font-bold text-sm mb-1">${car.plateNumber}</div>
                    <div class="text-xs text-gray-600 mb-2">${car.ownerName || ''}</div>
                    ${car.carType || car.model ? `<div class="text-xs text-gray-500">${car.carType || ''} ${car.model || ''}</div>` : ''}
                    
                    <!-- Status Buttons -->
                    <div class="mt-2 flex gap-1 flex-wrap" onclick="event.stopPropagation()">
                        ${status !== 'waiting' ? `<button onclick="changeCarStatus('${car.id}', 'waiting')" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded hover:bg-yellow-200" title="העבר לממתין">⏳</button>` : ''}
                        ${status !== 'in_progress' ? `<button onclick="changeCarStatus('${car.id}', 'in_progress')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200" title="העבר לטיפול">🔧</button>` : ''}
                        ${status !== 'ready' ? `<button onclick="changeCarStatus('${car.id}', 'ready')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200" title="סמן כמוכן">✅</button>` : ''}
                        ${status !== 'completed' ? `<button onclick="changeCarStatus('${car.id}', 'completed')" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200" title="סמן כהושלם">🏁</button>` : ''}
                        ${status === 'completed' ? `<button onclick="deleteCarFromDashboard('${car.id}')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200" title="מחק מהמערכת">🗑️</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Get Status Color
        function getStatusColor(status) {
            const colors = {
                'waiting': 'border-yellow-500',
                'in_progress': 'border-blue-500',
                'ready': 'border-green-500',
                'completed': 'border-gray-500'
            };
            return colors[status] || 'border-gray-300';
        }

        // Change Car Status
        async function changeCarStatus(carId, newStatus) {
            try {
                await db.collection('cars').doc(carId).update({
                    carStatus: newStatus,
                    statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local cars array
                const carIndex = cars.findIndex(c => c.id === carId);
                if (carIndex !== -1) {
                    cars[carIndex].carStatus = newStatus;
                }
                
                renderDashboard();
                
                // Show notification
                const statusNames = {
                    'waiting': 'ממתין לטיפול',
                    'in_progress': 'בטיפול',
                    'ready': 'מוכן לאיסוף',
                    'completed': 'הושלם'
                };
                
                const car = cars.find(c => c.id === carId);
                showNotification(`${car.plateNumber} הועבר ל: ${statusNames[newStatus]}`);
                
            } catch (error) {
                console.error('Error changing car status:', error);
                alert('שגיאה בעדכון הסטטוס');
            }
        }

        // Show Notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[100]';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // Delete Car from Dashboard
        async function deleteCarFromDashboard(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            if (!confirm(`האם אתה בטוח שברצונך למחוק את ${car.plateNumber} מהמערכת?`)) return;
            
            try {
                // Delete car
                await db.collection('cars').doc(carId).delete();
                
                // Delete all maintenance records for this car
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('carId', '==', carId)
                    .get();
                
                const deletePromises = [];
                maintenanceSnapshot.forEach(doc => {
                    deletePromises.push(db.collection('maintenance').doc(doc.id).delete());
                });
                
                await Promise.all(deletePromises);
                
                // Update local array
                cars = cars.filter(c => c.id !== carId);
                
                renderDashboard();
                showNotification('הרכב נמחק בהצלחה');
                
            } catch (error) {
                console.error('Error deleting car:', error);
                alert('שגיאה במחיקת הרכב');
            }
        }

        // ==========================================
        // SETTINGS FUNCTIONS
        // ==========================================

        let sparePartsPhone = '';

        // Load Settings
        async function loadSettings() {
            try {
                const settingsDoc = await db.collection('settings').doc(currentUser.uid).get();
                if (settingsDoc.exists) {
                    sparePartsPhone = settingsDoc.data().sparePartsPhone || '';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Open Settings
        async function openSettings() {
            await loadSettings();
            document.getElementById('sparePartsPhone').value = sparePartsPhone;
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        // Close Settings
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // Save Settings
        async function saveSettings() {
            try {
                const phone = document.getElementById('sparePartsPhone').value.trim();
                
                await db.collection('settings').doc(currentUser.uid).set({
                    sparePartsPhone: phone,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                sparePartsPhone = phone;
                closeSettings();
                showNotification('ההגדרות נשמרו בהצלחה');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('שגיאה בשמירת ההגדרות');
            }
        }

        // Order Spare Part via WhatsApp
        async function orderSparePart(partName, carType, model, year) {
            // Load settings if not loaded
            if (!sparePartsPhone) {
                await loadSettings();
            }
            
            if (!sparePartsPhone) {
                alert('אנא הגדר מספר טלפון של חנות חלפים בהגדרות');
                openSettings();
                return;
            }
            
            const phone = sparePartsPhone.replace(/^0/, '972').replace(/[^0-9]/g, '');
            const message = `שלום,\n\nאני מעוניין להזמין:\n📦 חלק: ${partName}\n\n🚗 רכב:\nסוג: ${carType}\nדגם: ${model}\nשנה: ${year}\n\nתודה!`;
            
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // ==========================================
        // BACKUP & RESTORE FUNCTIONS
        // ==========================================

        // Open Backup Modal
        function openBackupModal() {
            document.getElementById('backupModal').classList.remove('hidden');
            updateBackupInfo();
        }

        // Close Backup Modal
        function closeBackupModal() {
            document.getElementById('backupModal').classList.add('hidden');
        }

        // Update Backup Info
        async function updateBackupInfo() {
            try {
                const totalCars = cars.length;
                
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                const totalMaintenance = maintenanceSnapshot.size;
                
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                const totalAppointments = appointmentsSnapshot.size;
                
                document.getElementById('totalDataCount').textContent = 
                    `${totalCars} רכבים, ${totalMaintenance} טיפולים, ${totalAppointments} פגישות`;
                
                // Get last backup date from localStorage
                const lastBackup = localStorage.getItem('lastBackupDate');
                if (lastBackup) {
                    document.getElementById('lastBackupDate').textContent = 
                        new Date(lastBackup).toLocaleString('he-IL');
                }
                
            } catch (error) {
                console.error('Error updating backup info:', error);
            }
        }

        // Create Backup (without images)
        async function createBackup() {
            try {
                showBackupProgress(true);
                updateBackupProgress(10, 'אוסף נתונים...');
                
                // Collect all data
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    cars: [],
                    maintenance: [],
                    appointments: [],
                    settings: {}
                };
                
                updateBackupProgress(30, 'מייצא רכבים...');
                // Get cars (without images)
                backupData.cars = cars.map(car => ({
                    ...car,
                    imageUrl: null // Remove images to keep backup small
                }));
                
                updateBackupProgress(50, 'מייצא טיפולים...');
                // Get maintenance (without images)
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                maintenanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.maintenance.push({
                        id: doc.id,
                        ...data,
                        images: [], // Remove images
                        createdAt: data.createdAt?.toMillis() || null,
                        updatedAt: data.updatedAt?.toMillis() || null
                    });
                });
                
                updateBackupProgress(70, 'מייצא פגישות...');
                // Get appointments
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointmentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.appointments.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toMillis() || null
                    });
                });
                
                updateBackupProgress(90, 'שומר קובץ...');
                // Get settings
                const settingsDoc = await db.collection('settings').doc(currentUser.uid).get();
                if (settingsDoc.exists) {
                    backupData.settings = settingsDoc.data();
                }
                
                // Create and download file
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garage-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                // Save last backup date
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                
                updateBackupProgress(100, 'הגיבוי הושלם!');
                setTimeout(() => {
                    showBackupProgress(false);
                    showNotification('הגיבוי נוצר בהצלחה!');
                    updateBackupInfo();
                }, 1000);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('שגיאה ביצירת גיבוי: ' + error.message);
                showBackupProgress(false);
            }
        }

        // Create Backup with Images
        async function createBackupWithImages() {
            if (!confirm('גיבוי עם תמונות עשוי להיות קובץ גדול מאוד. להמשיך?')) return;
            
            try {
                showBackupProgress(true);
                updateBackupProgress(10, 'אוסף נתונים...');
                
                // Same as createBackup but include images
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    cars: [],
                    maintenance: [],
                    appointments: [],
                    settings: {}
                };
                
                updateBackupProgress(30, 'מייצא רכבים עם תמונות...');
                backupData.cars = [...cars]; // Include images
                
                updateBackupProgress(50, 'מייצא טיפולים עם תמונות...');
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                maintenanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.maintenance.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toMillis() || null,
                        updatedAt: data.updatedAt?.toMillis() || null
                    });
                });
                
                updateBackupProgress(70, 'מייצא פגישות...');
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointmentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.appointments.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toMillis() || null
                    });
                });
                
                updateBackupProgress(90, 'שומר קובץ...');
                const settingsDoc = await db.collection('settings').doc(currentUser.uid).get();
                if (settingsDoc.exists) {
                    backupData.settings = settingsDoc.data();
                }
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garage-backup-full-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                
                updateBackupProgress(100, 'הגיבוי הושלם!');
                setTimeout(() => {
                    showBackupProgress(false);
                    showNotification('הגיבוי נוצר בהצלחה!');
                    updateBackupInfo();
                }, 1000);
                
            } catch (error) {
                console.error('Error creating backup with images:', error);
                alert('שגיאה ביצירת גיבוי: ' + error.message);
                showBackupProgress(false);
            }
        }

        // Show/Hide Backup Progress
        function showBackupProgress(show) {
            const progress = document.getElementById('backupProgress');
            if (show) {
                progress.classList.remove('hidden');
            } else {
                progress.classList.add('hidden');
                updateBackupProgress(0, '');
            }
        }

        // Update Backup Progress
        function updateBackupProgress(percent, text) {
            document.getElementById('backupProgressBar').style.width = percent + '%';
            document.getElementById('backupProgressText').textContent = text;
        }

        // Handle Restore File
        async function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('האם אתה בטוח? זה ימחק את כל הנתונים הנוכחיים!')) {
                event.target.value = '';
                return;
            }
            
            try {
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                // Validate backup
                if (!backupData.version || !backupData.cars) {
                    throw new Error('קובץ גיבוי לא תקין');
                }
                
                showBackupProgress(true);
                updateBackupProgress(10, 'מוחק נתונים ישנים...');
                
                // Delete existing data
                await deleteAllUserData();
                
                updateBackupProgress(30, 'משחזר רכבים...');
                // Restore cars
                for (const car of backupData.cars) {
                    const carData = { ...car };
                    delete carData.id;
                    await db.collection('cars').add(carData);
                }
                
                updateBackupProgress(50, 'משחזר טיפולים...');
                // Restore maintenance
                for (const maintenance of backupData.maintenance) {
                    const maintenanceData = { ...maintenance };
                    delete maintenanceData.id;
                    
                    // Convert timestamps back
                    if (maintenanceData.createdAt) {
                        maintenanceData.createdAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.createdAt);
                    }
                    if (maintenanceData.updatedAt) {
                        maintenanceData.updatedAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.updatedAt);
                    }
                    
                    await db.collection('maintenance').add(maintenanceData);
                }
                
                updateBackupProgress(70, 'משחזר פגישות...');
                // Restore appointments
                for (const appointment of backupData.appointments) {
                    const appointmentData = { ...appointment };
                    delete appointmentData.id;
                    
                    if (appointmentData.createdAt) {
                        appointmentData.createdAt = firebase.firestore.Timestamp.fromMillis(appointmentData.createdAt);
                    }
                    
                    await db.collection('appointments').add(appointmentData);
                }
                
                updateBackupProgress(90, 'משחזר הגדרות...');
                // Restore settings
                if (backupData.settings) {
                    await db.collection('settings').doc(currentUser.uid).set(backupData.settings);
                }
                
                updateBackupProgress(100, 'השחזור הושלם!');
                setTimeout(() => {
                    showBackupProgress(false);
                    alert('השחזור הושלם בהצלחה! הדף יתרענן כעת.');
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                alert('שגיאה בשחזור גיבוי: ' + error.message);
                showBackupProgress(false);
            }
            
            event.target.value = '';
        }

        // Delete All User Data
        async function deleteAllUserData() {
            // Delete cars
            const carsSnapshot = await db.collection('cars')
                .where('userId', '==', currentUser.uid)
                .get();
            
            const deletePromises = [];
            carsSnapshot.forEach(doc => {
                deletePromises.push(db.collection('cars').doc(doc.id).delete());
            });
            
            // Delete maintenance
            const maintenanceSnapshot = await db.collection('maintenance')
                .where('userId', '==', currentUser.uid)
                .get();
            
            maintenanceSnapshot.forEach(doc => {
                deletePromises.push(db.collection('maintenance').doc(doc.id).delete());
            });
            
            // Delete appointments
            const appointmentsSnapshot = await db.collection('appointments')
                .where('userId', '==', currentUser.uid)
                .get();
            
            appointmentsSnapshot.forEach(doc => {
                deletePromises.push(db.collection('appointments').doc(doc.id).delete());
            });
            
            await Promise.all(deletePromises);
        }

        // ==========================================
        // Browser Back Button Support for Mobile
        // ==========================================
        
        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            const carModal = document.getElementById('carModal');
            const detailsModal = document.getElementById('carDetailsModal');
            const maintenanceModal = document.getElementById('maintenanceModal');
            const calendarModal = document.getElementById('calendarModal');
            const appointmentModal = document.getElementById('appointmentModal');
            const dashboardModal = document.getElementById('dashboardModal');
            
            // Close any open modal when back button is pressed
            if (dashboardModal && !dashboardModal.classList.contains('hidden')) {
                closeDashboard();
            } else if (appointmentModal && !appointmentModal.classList.contains('hidden')) {
                closeAppointmentModal();
            } else if (calendarModal && !calendarModal.classList.contains('hidden')) {
                closeCalendarModal();
            } else if (carModal && !carModal.classList.contains('hidden')) {
                closeCarModal();
            } else if (maintenanceModal && !maintenanceModal.classList.contains('hidden')) {
                closeMaintenanceModal();
            } else if (detailsModal && !detailsModal.classList.contains('hidden')) {
                closeCarDetailsModal();
            }
        });

        // Wrap modal open functions to add history state
        (function() {
            // Save original functions
            const _openCarModal = window.openCarModal;
            const _openCarDetailsModal = window.openCarDetailsModal;
            const _openMaintenanceModal = window.openMaintenanceModal;
            const _openCalendarModal = window.openCalendarModal;
            const _openAppointmentModal = window.openAppointmentModal;
            const _openDashboard = window.openDashboard;
            
            // Override openCarModal
            window.openCarModal = function() {
                _openCarModal();
                history.pushState({ modal: 'car' }, '', '');
            };
            
            // Override openCarDetailsModal
            window.openCarDetailsModal = function(carId) {
                _openCarDetailsModal(carId);
                history.pushState({ modal: 'details' }, '', '');
            };
            
            // Override openMaintenanceModal
            window.openMaintenanceModal = function() {
                _openMaintenanceModal();
                history.pushState({ modal: 'maintenance' }, '', '');
            };
            
            // Override openCalendarModal
            window.openCalendarModal = function() {
                _openCalendarModal();
                history.pushState({ modal: 'calendar' }, '', '');
            };
            
            // Override openAppointmentModal
            window.openAppointmentModal = function() {
                _openAppointmentModal();
                history.pushState({ modal: 'appointment' }, '', '');
            };
            
            // Override openDashboard
            window.openDashboard = function() {
                _openDashboard();
                history.pushState({ modal: 'dashboard' }, '', '');
            };
        })();
    </script>

</body>
</html>
